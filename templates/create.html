{% extends "index.html" %}
{% block content %}
<h2 class="title-h2">О подарке</h2>
<div class="spacer"></div>
<form method="post" role="presentSubmit">
    <div class="present">
    <aside class="form-item present__photo">
        <img class="present__icon" src="/static/images/photo-icon.svg" alt=""/>
        <div class="fileupload present__fileupload">
            <button class="present__fileupload-button">Загрузить фотографию</button>
            <input id="fileupload" type="file" name="image_file" data-url="/upload"/>
            {{ form.image(type="hidden")|safe }}
		</div>
		<span class="form-item__error"></span>
	</aside>
    <aside class="form-item present__desc">
        {{ form.description(placeholder='Расскажите о подарке')|safe }}
		<span class="form-item__error"></span>
    </aside>
	<div class="clearfix"></div>
    </div>
    <div class="spacer spacer--big"></div>
    <h2 class="title-h2">Реквизиты</h2>
    <div class="spacer"></div>
    <div class="form-item">
        <label class="form-item__label" for="present[sum]">Сумма:</label>
        {{ form.amount(class="form-item__input-text", placeholder='Требуемая сумма', id='present[sum]') }}
        <span class="currency">руб.</span>
		<span class="form-item__error"></span>
	</div>
    <div class="spacer spacer--small"></div>
    <div class="form-item">
        <label class="form-item__label" for="present[cardnumber]">Номер карты:</label>
        {{ form.card(class="form-item__input-text", id='present[cardnumber]', placeholder='XXXX-XXXX-XXXX-XXXX') }}
		<span class="form-item__error"></span>
    </div>
    <div class="spacer spacer--big"></div>
    <div class="form-item form-item--submit">
        <input class="button button__full-color" type="submit" value="Отправить"/>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="/static/js/vendor/jquery.ui.widget.js"></script>
<script src="/static/js/jquery.iframe-transport.js"></script>
<script src="/static/js/jquery.fileupload.js"></script>
<script>
$(function () {

	$cardField = $('#present\\[cardnumber\\]');

	function updateImage(data){
		var imageUrl = $('#image')[0],
			$imageWrapper = $('.present__photo'),
			$button = $('.present__fileupload-button');


			if(data){
				imageUrl.value = localStorage.imageUrl = data.result.file.url
			}

			$imageWrapper.css('background-image', 'url(' + localStorage.imageUrl + ')');
			$('.present__icon').hide();

			if(localStorage.imageUrl){
				imageUrl.value = localStorage.imageUrl;
				$button.html('Изменить');
				$('.form-item__error', $imageWrapper).removeClass('form-item__error--show');
			}
	}

	updateImage();

	$('#fileupload').fileupload({
        dataType: 'json',
        done: function (e, data) {
			updateImage(data)
        }
    });

	var errorList = {{ form.errors|tojson|safe }};

	var formValidate = {
		formNode: $('form[role="presentSubmit"]'),
		errorArray: errorList,
		classError: 'form-item__error--show',
			showError: function(){
			for(var inputItem in this.errorArray){
				$('[name='+inputItem+']')
						.parents('.form-item')
						.find('.form-item__error')
						.html(this.errorArray[inputItem])
						.addClass(this.classError)
			}
		}
	};

	if(errorList){
		formValidate.showError();
	};


	formValidate.formNode.on('submit', function(event){
		$cardField.val($cardField.val().replace(/-/g,''));
	});

});

</script>
{% endblock %}